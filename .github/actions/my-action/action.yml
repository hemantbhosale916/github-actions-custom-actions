name: "Docker Build & Deploy"
description: "Build Docker image and push to ECR / deploy to Kubernetes"
inputs:
  aws-region:
    description: "AWS Region"
    required: true
  ecr-repo:
    description: "ECR repository name"
    required: true
  image-tag:
    description: "Docker image tag"
    required: true
runs:
  using: "composite"
  steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.aws-region }}
        
    - name: Build Docker image
      run: docker build -t ${{ inputs.ecr-repo }}:${{ inputs.image-tag }} .
      
    - name: Push to ECR
      run: |
        aws ecr get-login-password --region ${{ inputs.aws-region }} | docker login --username AWS --password-stdin <account-id>.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com
        docker tag ${{ inputs.ecr-repo }}:${{ inputs.image-tag }} <account-id>.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com/${{ inputs.ecr-repo }}:${{ inputs.image-tag }}
        docker push <account-id>.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com/${{ inputs.ecr-repo }}:${{ inputs.image-tag }}
